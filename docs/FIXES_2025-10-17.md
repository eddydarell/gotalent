# Issues Fixed - October 17, 2025

## Issue 1: Database Initialization ✅ FIXED

### Problem
- Form service couldn't create inscriptions
- Error: `SQLiteError: no such table: participants`
- Database file existed but was empty (0 bytes)

### Root Cause
- The db-init service was trying to use `sqlite3` CLI command which wasn't working properly
- The init script was attempting `bun install sqlite3; bun x sqlite3` which was hanging

### Solution
1. Created `/data/init-db.js` - A Bun script that uses native `bun:sqlite` to initialize the database
2. Updated `compose.yml` db-init service to use `bun run /init-db.js` instead of sqlite3 CLI
3. Used `db.exec(sql)` to execute the entire SQL script at once (handles triggers correctly)

### Result
- Database properly initialized with both `participants` and `paiement` tables
- Database file size: 49KB (was 0 bytes before)
- All services can now access the database successfully

## Issue 2: Caddy Reverse Proxy Routing ✅ FIXED

### Problem
- Direct links (ports 13001-13004) worked fine
- Caddy reverse proxy routes didn't work
- Routes like http://localhost:13000/form were not forwarding correctly

### Root Cause
- Used `handle` directive instead of `handle_path`
- The path prefixes (/form, /badge, /scanner) were being sent to backend services
- Backend services don't expect these prefixes in their routes

### Solution
Changed Caddyfile from:
```
handle /form* {
    reverse_proxy form:3002
}
```

To:
```
handle_path /form* {
    reverse_proxy form:3002
}
```

### Result
- All Caddy routes now working correctly:
  - ✅ http://localhost:13000/ → landing
  - ✅ http://localhost:13000/form → form service
  - ✅ http://localhost:13000/badge → badge service
  - ✅ http://localhost:13000/scanner → scanner service
  - ✅ http://localhost:13000/db → adminer

## Testing Commands

### Test Database
```bash
# Check database exists and has tables
sqlite3 /Users/eddyntambwe/Dev/gotalent/data/gotalent.db ".tables"

# Check participant count
sqlite3 /Users/eddyntambwe/Dev/gotalent/data/gotalent.db "SELECT COUNT(*) FROM participants;"
```

### Test Caddy Routing
```bash
# Test all routes
curl -I http://localhost:13000/         # Landing page
curl -I http://localhost:13000/form     # Form service
curl -I http://localhost:13000/badge    # Badge service
curl -I http://localhost:13000/scanner  # Scanner service
curl -I http://localhost:13000/db       # Adminer
```

### Test Form API
```bash
# Create inscription (use correct field names)
curl -X POST http://localhost:13002/api/inscriptions \
  -H "Content-Type: application/json" \
  -d '{
    "nom": "Doe",
    "prenom": "John",
    "email": "john.doe@example.com",
    "telephone": "+243900000001",
    "sexe": "M",
    "diplome": "Licence",
    "etablissement": "University",
    "anneeObtention": 2020,
    "poste": "Developer",
    "commentEntendu": ["Internet"],
    "attentes": ["Networking"],
    "accepteTermes": true,
    "accepteUtilisationDonnees": true
  }'
```

## Files Modified

1. `/Users/eddyntambwe/Dev/gotalent/data/init-db.js` - NEW
   - Bun script to initialize database using native SQLite

2. `/Users/eddyntambwe/Dev/gotalent/compose.yml`
   - Updated db-init service to use Bun script
   - Added init-db.js volume mount

3. `/Users/eddyntambwe/Dev/gotalent/Caddyfile`
   - Changed `handle` to `handle_path` for all service routes
   - This strips the path prefix before forwarding

## Current Status

✅ All 7 services running successfully
✅ Database initialized with proper schema
✅ Caddy reverse proxy routing working
✅ Form API accepting inscriptions
✅ Badge API working
✅ Scanner API working
✅ Adminer accessible

### Service URLs

**Via Caddy (Recommended)**:
- Landing: http://localhost:13000/
- Form: http://localhost:13000/form
- Badge: http://localhost:13000/badge
- Scanner: http://localhost:13000/scanner
- Adminer: http://localhost:13000/db

**Direct Access**:
- Landing: http://localhost:13001
- Form: http://localhost:13002
- Badge: http://localhost:13003
- Scanner: http://localhost:13004
- Adminer: http://localhost:13080

## Next Steps

1. ✅ Database initialization - COMPLETE
2. ✅ Caddy reverse proxy - COMPLETE
3. ⏳ Test form inscription submission through UI
4. ⏳ Apply unified design system to all services
5. ⏳ Integration testing across all services
